name: üîí Secrets Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily scan at 2 AM
    - cron: '0 2 * * *'

jobs:
  secrets-scan:
    name: Scan for exposed secrets
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: üîç TruffleHog Secrets Scan
        # Only run on pull requests where we have a base branch to compare
        # Skip on scheduled runs (no commits) and push events (may have BASE==HEAD)
        if: github.event_name == 'pull_request'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.base_ref }}
          head: HEAD
          extra_args: --debug --only-verified
        continue-on-error: true

      - name: üîç GitGuardian Scan
        uses: GitGuardian/ggshield-action@master
        env:
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
          GITHUB_PUSH_BEFORE_SHA: ${{ github.event.before }}
          GITHUB_PUSH_BASE_SHA: ${{ github.base_ref }}
          GITHUB_PULL_BASE_SHA: ${{ github.base_ref }}
          GITHUB_DEFAULT_BRANCH: main
        continue-on-error: true

      - name: üìã Report Scan Results
        if: failure()
        run: |
          echo "## ‚ö†Ô∏è Security Scan Failed"
          echo "Secrets were detected in your commit. Please:"
          echo "1. Review the scan results above"
          echo "2. Remove any exposed secrets"
          echo "3. Force push the cleaned commit (if in your own branch)"
          exit 1

  dotenv-scan:
    name: Verify .env files are ignored
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check .gitignore includes sensitive files
        run: |
          if ! grep -q "\.env" .gitignore; then
            echo "‚ùå .env files not in .gitignore"
            exit 1
          fi
          if ! grep -q "kubeadm-config/join-command" .gitignore; then
            echo "‚ùå kubeadm-config/join-command.sh not in .gitignore"
            exit 1
          fi
          if ! grep -q "*.secret" .gitignore; then
            echo "‚ùå *.secret files not in .gitignore"
            exit 1
          fi
          echo "‚úÖ .gitignore properly configured for secrets"

      - name: Verify no secrets committed
        run: |
          # Check for common secret patterns
          if git log -p | grep -i "password\|token\|secret\|api[_-]?key" | grep -v "docs/" | grep -v "SECURITY.md"; then
            echo "‚ö†Ô∏è  Possible secrets found in Git history"
          else
            echo "‚úÖ No obvious secrets in Git history"
          fi
